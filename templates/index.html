<!DOCTYPE html>
<html lang="en">
<head>
    <title>Contact QR Code Generator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="bootstrap/dist/css/bootstrap.min.css">
    <script src="bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="smoothscroll-polyfill/dist/smoothscroll.min.js"></script>
    <style>
        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }

        /* Scale output image */
        #output {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <!-- Full viewport height -->
    <div class="d-flex flex-column vh-100">

        <!-- Fixed nav bar reserves space -->
        <nav class="navbar navbar-dark bg-primary fixed-top">
            <div class="container-fluid">
                <h1 class="mb-0 navbar-brand mx-auto">QR Code Generator</h1>
            </div>
        </nav>

        <!-- Container reserves remaining space -->
        <div class="container d-flex flex-column h-100">
            <!-- Side by side on desktop, stacked on mobile -->
            <div class="row h-100">

                <!-- Same height as container to vertically center contents -->
                <div class="col-md-6 d-flex flex-column justify-content-center py-3 h-100">
                    <form>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="firstName" id="firstName" placeholder="First Name">
                            <label for="firstName">First Name</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="lastName" id="lastName" placeholder="Last Name">
                            <label for="lastName">Last Name</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" name="email" id="email" placeholder="Email" pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$">
                            <label for="email">Email</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" name="phone" id="phone" placeholder="Phone" pattern="^(\d{10}|\(\d{3}\) \d{3}-\d{4})$">
                            <label for="phone">Phone</label>
                        </div>

                        <div class="d-flex">
                            <button type="button" onclick="generate();" class="btn btn-primary mx-auto">Generate</button>
                        </div>
                    </form>
                </div>

                <!-- Same height as container again, 2-page layout when stacked -->
                <!-- Hidden before QR loads (prevent scrolling to blank area) -->
                <div id="output_column" class="col-md-6 flex-column justify-content-center align-items-center py-3 h-100" style="display:none;">
                    <!-- Keep QR vertically centered, hidden button negates download button impact on layout -->
                    <a style="visibility:hidden;"><button type="submit" class="btn btn-primary mt-3">Download</button></a>

                    <!-- Output image + download button -->
                    <img id="output" src=""></img>
                    <a href="" id="download"><button type="submit" class="btn btn-primary mb-3">Download</button></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add invalid highlight + listener to remove highlight on input
        function markInvalid(element) {
            element.classList.add('is-invalid');
            element.addEventListener("input", (e) => {
                e.target.classList.remove("is-invalid");
            }, { once: true });
        };

        // Takes form data, marks invalid fields, returns true if all valid
        function isValid(data) {
            let valid = true;

            for (i in data) {
                // Invalid if blank
                if (data[i] == "") {
                    markInvalid(document.getElementById(i));
                    valid = false;

                // Invalid if failed regex
                } else if (!document.getElementById(i).validity.valid) {
                    markInvalid(document.getElementById(i));
                    valid = false;
                };
            };

            return valid;
        };

        async function generate() {
            // Get form data, validate
            const data = Object.fromEntries(new FormData(document.querySelector('form')).entries());
            if (!isValid(data)) {return false};
            console.log(data);

            // Post form data, receive base64 PNG
            var result = await fetch('/generate', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json' }
            });

            result = await result.text();

            // Add image to right column, show
            document.getElementById('output').src = "data:image/png;base64," + result;
            document.getElementById('output_column').classList.add('d-flex');

            // Set download button target, scroll into view
            document.getElementById('download').href = `/download/${data.firstName.trim()}-${data.lastName.trim()}`;
            document.getElementById('download').scrollIntoView({behavior: "smooth"});
        };

        // Format phone number as user types
        document.getElementById('phone').addEventListener('input', function(event) {
            // Allow backspace and delete
            // TODO doesn't work bc input, not keydown
            if (event.keyCode === 8 || event.keyCode === 46) {
                console.log('foo')
                return false
            };

            // Remove all non-numeric characters, 10 digits max
            const input = event.target.value.replace(/\D/g,'').substring(0,10);

            // Parse phone number sections
            const areaCode = input.substring(0,3);
            const middle = input.substring(3,6);
            const last = input.substring(6,10);

            // Format based on current length
            if (input.length > 6) { event.target.value = `(${areaCode}) ${middle}-${last}`; }
            else if (input.length > 3) { event.target.value = `(${areaCode}) ${middle}`; }
            else if (input.length > 2) { event.target.value = `(${areaCode}) `; }
            else if (input.length > 0) { event.target.value = `(${areaCode}`; };
        });

        // Allow all characters except spaces in email field
        document.getElementById('email').addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
            };
        });

        // Press enter to generate
        document.querySelector("form").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                generate();
            };
        });
    </script>
</body>
</html>
