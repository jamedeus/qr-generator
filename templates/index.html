<!DOCTYPE html>
<html lang="en">
<head>
    <title>Contact QR Code Generator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="bootstrap-icons/font/bootstrap-icons.css">
    <script src="bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="smoothscroll-polyfill/dist/smoothscroll.min.js"></script>
    <style>
        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }

        /* Scale output image */
        #output {
            width: 100%;
            height: auto;
        }

        /* Remove top right corner button border */
        #menu_button {
            border: 0px;
        }

        /* Fade out results column while changing type */
        @keyframes fade-out {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .fade-out {
            animation: fade-out 0.25s ease-out forwards;
        }

        /* Fade in generated QR code */
        @keyframes fade-in {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fade-in 0.25s ease forwards;
        }

    </style>
</head>
<body>
    <!-- Full viewport height -->
    <div class="d-flex flex-column vh-100">

        <!-- Fixed nav bar reserves space -->
        <nav class="navbar navbar-dark bg-primary fixed-top">
            <div class="container-fluid">
                <button type="button" class="btn" style='visibility:hidden;'><i class="bi-list"></i></button>
                <h1 class="mb-0 navbar-brand mx-auto">QR Code Generator</h1>

                <!-- Dropdown to select QR Code type -->
                <div class="dropdown my-auto">
                    <button type="button" class="btn" id="menu_button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list" style="color: #fff;"></i></button>
                    <ul id="settings_menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="settings_button">
                        <li><a class="dropdown-item active" data-target="contact-qr" onclick="change_form(this)"><i class="bi bi-person-lines-fill me-3"></i>Contact</a></li>
                        <li><a class="dropdown-item" data-target="wifi-qr" onclick="change_form(this)"><i class="bi bi-wifi me-3"></i>Wifi</a></li>
                        <li><a class="dropdown-item" data-target="link-qr" onclick="change_form(this)"><i class="bi bi-link-45deg me-3"></i>Link</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Container reserves remaining space -->
        <div class="container d-flex flex-column h-100">
            <!-- Side by side on desktop, stacked on mobile -->
            <div class="row h-100">

                <!-- Same height as container to vertically center contents -->
                <div class="col-md-6 d-flex flex-column justify-content-center py-3 h-100">

                    <!-- Contact Info Form -->
                    <form id="contact-qr">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="firstName" id="firstName" placeholder="First Name">
                            <label for="firstName">First Name</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="lastName" id="lastName" placeholder="Last Name">
                            <label for="lastName">Last Name</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" name="email" id="email" placeholder="Email" pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$">
                            <label for="email">Email</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" name="phone" id="phone" placeholder="Phone" pattern="^(\d{10}|\(\d{3}\) \d{3}-\d{4})$">
                            <label for="phone">Phone</label>
                        </div>

                        <div class="d-flex">
                            <button type="button" onclick="generate('contact-qr');" class="btn btn-primary mx-auto">Generate</button>
                        </div>
                    </form>

                    <!-- Wifi Form -->
                    <form id="wifi-qr" class="d-none">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="ssid" id="ssid" placeholder="SSID">
                            <label for="ssid">SSID</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input type="password" class="form-control" name="password" id="password" placeholder="*******">
                            <label for="password">password</label>
                        </div>

                        <div class="d-flex">
                            <button type="button" onclick="generate('wifi-qr');" class="btn btn-primary mx-auto">Generate</button>
                        </div>
                    </form>

                    <!-- URL Form -->
                    <form id="link-qr" class="d-none">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" name="url" id="url" placeholder="" value="https://">
                            <label for="url">URL</label>
                        </div>

                        <div class="d-flex">
                            <button type="button" onclick="generate('link-qr');" class="btn btn-primary mx-auto">Generate</button>
                        </div>
                    </form>

                </div>

                <!-- Same height as container again, 2-page layout when stacked -->
                <!-- Hidden before QR loads (prevent scrolling to blank area) -->
                <div id="output_column" class="col-md-6 flex-column justify-content-center align-items-center py-3 h-100" style="display:none;">
                    <!-- Keep QR vertically centered, hidden button negates download button impact on layout -->
                    <a style="visibility:hidden;"><button type="submit" class="btn btn-primary mt-3">Download</button></a>

                    <!-- Output image + download button -->
                    <img id="output" src=""></img>
                    <a id="download" class="btn btn-primary mb-3">Download</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        };

        // Change visible form when top-right menu used
        async function change_form(el) {
            // Hide all forms, mark all dropdown options inactive
            document.querySelectorAll('form').forEach(function(f){f.classList.add('d-none')});
            document.querySelectorAll('.dropdown-item').forEach(function(f){f.classList.remove('active')});

            // Show requested form, mark clicked option active
            document.getElementById(el.dataset.target).classList.remove('d-none');
            el.classList.add('active');

            // Fade out old QR, scroll to top (mobile)
            document.getElementById('output_column').classList.remove('fade-in');
            document.getElementById('output_column').classList.add('fade-out');
            window.scroll({ top: 0, left: 0, behavior: 'smooth' });

            // Wait for animation, hide result section, remove fade transition
            await sleep(468);
            document.getElementById('output_column').classList.remove('d-flex');
            document.getElementById('output_column').classList.remove('fade-out');
        };

        // Add invalid highlight + listener to remove highlight on input
        function markInvalid(element) {
            element.classList.add('is-invalid');
            element.addEventListener("input", (e) => {
                e.target.classList.remove("is-invalid");
            }, { once: true });
        };

        // Takes form data, marks invalid fields, returns true if all valid
        function isValid(data) {
            let valid = true;

            for (i in data) {
                // Invalid if blank
                if (data[i] == "") {
                    markInvalid(document.getElementById(i));
                    valid = false;

                // Invalid if failed regex
                } else if (!document.getElementById(i).validity.valid) {
                    markInvalid(document.getElementById(i));
                    valid = false;
                };
            };

            return valid;
        };

        // Called by generate buttons, takes ID of form as argument
        async function generate(type) {
            // Get form data, validate
            const data = Object.fromEntries(new FormData(document.querySelector(`#${type}`)).entries());
            if (!isValid(data)) {return false};
            console.log(data);

            // Add QR type
            data['type'] = type;

            // Post form data, receive base64 PNG
            var result = await fetch('/generate', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json' }
            });

            result = await result.text();
            console.log(result);

            // Add image to result section, fade in
            document.getElementById('output').src = "data:image/png;base64," + result;
            document.getElementById('output_column').classList.add('fade-in');
            document.getElementById('output_column').classList.add('d-flex');

            // Remove old listener (if present)
            document.getElementById('download').removeEventListener('click', downloadQR);

            // Add the new listener, bind base64 image string + qr type to handler function
            document.getElementById('download').addEventListener('click', downloadQR.bind({ result, type }));

            // Scroll to result section (mobile)
            document.getElementById('download').scrollIntoView({behavior: "smooth"});
        };

        // Decodes base64 image string from event to binary, serves download
        function downloadQR(event) {
            // Decode base64 image data to binary
            const imageData = atob(this.result);

            // Create Uint8Array with same length
            const imageBuffer = new ArrayBuffer(imageData.length);
            const imageBytes = new Uint8Array(imageBuffer);

            // Read bytes into array
            for (let i = 0; i < imageData.length; i++) {
                imageBytes[i] = imageData.charCodeAt(i);
            };

            // Create blob object from buffer, set MIME type
            const qr = new Blob([imageBytes], { type: 'image/png' });

            // Set download url and filename, downloads immediately
            event.target.href = URL.createObjectURL(qr);
            event.target.download = `${this.type}.png`;
        };

        // Format phone number as user types
        document.getElementById('phone').addEventListener('input', function(event) {
            // Remove all non-numeric characters, 10 digits max
            const input = event.target.value.replace(/\D/g,'').substring(0,10);

            // Parse phone number sections
            const areaCode = input.substring(0,3);
            const middle = input.substring(3,6);
            const last = input.substring(6,10);

            // Format based on current length
            if (input.length > 6) { event.target.value = `(${areaCode}) ${middle}-${last}`; }
            else if (input.length > 3) { event.target.value = `(${areaCode}) ${middle}`; }
            else if (input.length > 0) { event.target.value = `(${areaCode}`; }
            else if (input.length == 0) { event.target.value = ``; };
        });

        // Allow all characters except spaces in email field
        document.getElementById('email').addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                event.preventDefault();
            };
        });

        // Press enter to generate
        document.querySelector("form").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                generate();
            };
        });
    </script>
</body>
</html>
